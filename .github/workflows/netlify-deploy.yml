name: Netlify Deploy

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

on:
  push:
    branches: [main, tech-art-content, web-dev-content]
  pull_request:
    branches: ['main']

env:
  NODE_VERSION: '20'
  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

jobs:
  # Format Code
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      - run: npm ci
      - run: npx prettier --write "src/**/*.{js,jsx,ts,tsx,css,scss,json}"
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'style: format code with prettier'

  # Deploy Main
  deploy-main:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - run: npm ci
      - run: npm run build
      - name: Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=build --prod
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # Deploy Tech Art
  deploy-tech-art:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/tech-art-content'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - run: npm ci
      - run: npm run build
      - name: Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=build --prod
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # Deploy Web Dev
  deploy-web-dev:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/web-dev-content'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - run: npm ci
      - run: npm run build
      - name: Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=build --prod
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # Notification (runs regardless of which deploy ran)
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-main, deploy-tech-art, deploy-web-dev]
    if: always()
    steps:
      - name: Show Deployment Status
        run: |
          echo "Deploy Main: ${{ needs.deploy-main.result || 'skipped' }}"
          echo "Deploy Tech Art: ${{ needs.deploy-tech-art.result || 'skipped' }}"
          echo "Deploy Web Dev: ${{ needs.deploy-web-dev.result || 'skipped' }}"
